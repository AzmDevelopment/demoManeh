<div class="workflow-selector-container">
  <!-- Error State -->
  @if (error()) {
    <div class="error-message">
      <p>{{ error() }}</p>
      <button (click)="loadWorkflowDefinitions()" class="btn btn-retry">Retry</button>
    </div>
  }

  <!-- Workflow Selection View - Show when no workflow is selected -->
  @if (!selectedWorkflow()) {
    <div class="workflow-list">
      <h1>Available Workflows</h1>
      <p class="subtitle">Select a workflow to begin the certification process</p>

      <!-- Loading State for definitions -->
      @if (loading()) {
        <div class="loading-spinner">
          <div class="spinner"></div>
          <p>Loading workflow definitions...</p>
        </div>
      } @else if (workflows().length === 0) {
        <div class="no-workflows">
          <p>No workflows available.</p>
          <button (click)="loadWorkflowDefinitions()" class="btn btn-primary">Reload</button>
        </div>
      } @else {
        <div class="workflow-cards">
          @for (workflow of workflows(); track workflow.certificationId) {
            <div class="workflow-card" (click)="startWorkflow(workflow)">
              <div class="card-header">
                <h2>{{ workflow.name }}</h2>
                <span class="version-badge">v{{ workflow.version }}</span>
              </div>

              <p class="description">{{ workflow.description }}</p>

              @if (workflow.metadata) {
                <div class="metadata">
                  @if (workflow.metadata.estimatedTotalDurationDays) {
                    <div class="meta-item">
                      <span class="label">Duration:</span>
                      <span class="value">{{ workflow.metadata.estimatedTotalDurationDays }} days</span>
                    </div>
                  }
                  @if (workflow.metadata.complexity) {
                    <div class="meta-item">
                      <span class="label">Complexity:</span>
                      <span class="value complexity-badge" [ngClass]="getComplexityClass(workflow.metadata.complexity)">
                        {{ workflow.metadata.complexity }}
                      </span>
                    </div>
                  }
                  <div class="meta-item">
                    <span class="label">Steps:</span>
                    <span class="value">{{ (workflow.steps && workflow.steps.length) || 0 }}</span>
                  </div>
                  @if (workflow.metadata.requiresFactoryVisit) {
                    <div class="meta-item">
                      <span class="factory-visit-badge">Requires Factory Visit</span>
                    </div>
                  }
                </div>
              }

              <button class="btn btn-start">
                Start Workflow
                <span class="arrow">‚Üí</span>
              </button>
            </div>
          }
        </div>
      }
    </div>
  }

  <!-- Workflow Step View - Show when a workflow is selected -->
  @if (selectedWorkflow()) {
    <div class="workflow-step-view">
      <!-- Header with back button and status -->
      <div class="step-header">
        <button class="btn btn-back" (click)="backToWorkflowList()">
          ‚Üê Back to Workflows
        </button>
        <div class="header-content">
          <h1>{{ selectedWorkflow()?.name }}</h1>
          <!-- Workflow Status Badge -->
          @if (workflowStatus()) {
            <div class="status-section">
              <span class="status-badge" [ngClass]="getStatusClass()">
                {{ getStatusDisplayName() }}
              </span>
              @if (workflowStatus()?.description) {
                <span class="status-description">{{ workflowStatus()?.description }}</span>
              }
            </div>
          }
        </div>
      </div>

      <!-- Progress indicator with step status -->
      <div class="progress-bar">
        <div class="progress-track">
          @for (step of selectedWorkflow()?.steps; track $index; let i = $index) {
            <div class="progress-step"
                 [class.active]="i === currentStepIndex()"
                 [class.completed]="i < currentStepIndex()"
                 [class.pending]="i > currentStepIndex()">
              <span class="step-number">{{ i + 1 }}</span>
              @if (i < currentStepIndex()) {
                <span class="step-check">‚úì</span>
              }
            </div>
          }
        </div>
        <p class="step-counter">
          Step {{ currentStepIndex() + 1 }} of {{ (selectedWorkflow()?.steps && selectedWorkflow()!.steps.length) || 0 }}
          @if (stepStatus()) {
            <span class="step-status-text">({{ stepStatus()?.status }})</span>
          }
        </p>
      </div>

      <!-- Loading State for step -->
      @if (loading()) {
        <div class="loading-spinner">
          <div class="spinner"></div>
          <p>Loading step...</p>
        </div>
      } @else if (currentStep()) {
        <!-- Current Step Content -->
        <div class="step-content">
          <div class="step-info">
            <h2>{{ currentStep()?.name }}</h2>
            <p class="step-description">{{ currentStep()?.description }}</p>
            <div class="step-meta">
              <span class="actor-badge">Actor: {{ currentStep()?.actor }}</span>
              @if (currentStep()?.stepConfig?.estimatedDurationHours) {
                <span class="duration-badge">Est. Duration: {{ currentStep()?.stepConfig?.estimatedDurationHours }}h</span>
              }
              <!-- Step Status from State Machine -->
              @if (stepStatus()) {
                <span class="step-status-badge" [class]="'status-' + stepStatus()?.status">
                  Status: {{ stepStatus()?.status }}
                </span>
              }
            </div>
            
            <!-- Available Actions from State Machine -->
            @if (availableStepEvents().length > 0) {
              <div class="available-actions">
                <span class="actions-label">Available actions:</span>
                @for (event of availableStepEvents(); track event) {
                  <span class="action-chip">{{ event }}</span>
                }
              </div>
            }
          </div>

          <!-- Context Requirements Display (for debugging/info) -->
          @if (currentStep()?.context?.requires && currentStep()!.context!.requires!.length > 0) {
            <div class="context-info">
              <small>
                <strong>Requires from previous steps:</strong>
                {{ currentStep()?.context?.requires?.join(', ') }}
              </small>
            </div>
          }

          <!-- JSON Form -->
          @if (schema()) {
            <!-- JSON Forms format -->
            <div class="json-form-container">
              <app-json-form
                [schema]="schema()"
                [uischema]="uischema()"
                [data]="model"
                (dataChange)="onModelChange($event)">
              </app-json-form>

              <!-- Navigation buttons -->
              <div class="step-navigation">
                <!-- Save Progress Button -->
                <button type="button"
                        class="btn btn-secondary btn-save"
                        (click)="saveStepProgress()"
                        [disabled]="!canExecuteStepEvent('Save')">
                  üíæ Save Progress
                </button>

                <div class="nav-buttons">
                  <button type="button"
                          class="btn btn-secondary"
                          (click)="loadPreviousStep()"
                          [disabled]="!canGoBack()">
                    ‚Üê Previous Step
                  </button>

                  @if (!isLastStep()) {
                    <button type="button"
                            class="btn btn-primary"
                            (click)="onSubmit()"
                            [disabled]="!isFormValid() || !canExecuteStepEvent('Submit')">
                      Next Step ‚Üí
                    </button>
                  } @else {
                    <button type="button"
                            class="btn btn-success"
                            (click)="onSubmit()"
                            [disabled]="!isFormValid() || !canExecuteStepEvent('Submit')">
                      Complete Workflow ‚úì
                    </button>
                  }
                </div>
              </div>
            </div>
          } @else if (fields().length > 0) {
            <!-- Legacy fields format -->
            <div class="json-form-container">
              <app-json-form
                [fields]="fields()"
                [model]="model"
                (modelChange)="onModelChange($event)"
                (fieldChange)="onFieldChange($event)">
              </app-json-form>

              <!-- Navigation buttons -->
              <div class="step-navigation">
                <!-- Save Progress Button -->
                <button type="button"
                        class="btn btn-secondary btn-save"
                        (click)="saveStepProgress()"
                        [disabled]="!canExecuteStepEvent('Save')">
                  üíæ Save Progress
                </button>

                <div class="nav-buttons">
                  <button type="button"
                          class="btn btn-secondary"
                          (click)="loadPreviousStep()"
                          [disabled]="!canGoBack()">
                    ‚Üê Previous Step
                  </button>

                  @if (!isLastStep()) {
                    <button type="button"
                            class="btn btn-primary"
                            (click)="onSubmit()"
                            [disabled]="!isFormValid() || !canExecuteStepEvent('Submit')">
                      Next Step ‚Üí
                    </button>
                  } @else {
                    <button type="button"
                            class="btn btn-success"
                            (click)="onSubmit()"
                            [disabled]="!isFormValid() || !canExecuteStepEvent('Submit')">
                      Complete Workflow ‚úì
                    </button>
                  }
                </div>
              </div>
            </div>
          }
        </div>
      } @else if (currentStepIndex() === (selectedWorkflow()?.steps?.length ?? 0) - 1) {
        <!-- Completed State -->
        <div class="completed-state">
          <div class="success-icon">‚úì</div>
          <h2>Workflow Complete!</h2>
          <p>All steps have been completed successfully.</p>
          @if (workflowStatus()?.status === 'completed') {
            <p class="completion-status">Status: {{ workflowStatus()?.displayName }}</p>
          }
          <button class="btn btn-primary" (click)="backToWorkflowList()">
            Start Another Workflow
          </button>
        </div>
      }
    </div>
  }
</div>
