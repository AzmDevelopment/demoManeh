<div class="workflow-step-container">
  <!-- Loading State -->
  @if (loading) {
    <div class="loading-container">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="loading-text">Loading workflow step...</p>
    </div>
  }

  <!-- Error State -->
  @if (error && !loading) {
    <div class="alert alert-danger" role="alert">
      <i class="bi bi-exclamation-triangle-fill"></i>
      <span>{{ error }}</span>
    </div>
  }

  <!-- Workflow Step Content -->
  @if (!loading && !error && stepDefinition) {
    <div class="step-content">
      <!-- Breadcrumb -->
      <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
          <li class="breadcrumb-item">
            <a [routerLink]="['/']">Home</a>
          </li>
          <li class="breadcrumb-item">
            {{ instance.definitionId }}
          </li>
          <li class="breadcrumb-item active" aria-current="page">
            {{ stepDefinition.name }}
          </li>
        </ol>
      </nav>

      <!-- Step Header -->
      <div class="step-header">
        <div class="step-info">
          <h2 class="step-title">{{ stepDefinition.name }}</h2>
          <p class="step-description">{{ stepDefinition.description }}</p>
          <div class="step-meta">
            <span class="badge bg-primary">Step {{ stepDefinition.stepId }}</span>
            <span class="badge bg-info">{{ instance.status }}</span>
            <span class="badge bg-secondary">Assigned to: {{ instance.assignedActor }}</span>
          </div>
        </div>
      </div>

      <!-- Validation Errors -->
      @if (validationErrors.length > 0) {
        <div class="alert alert-danger">
          <h6><i class="bi bi-exclamation-circle"></i> Please fix the following errors:</h6>
          <ul class="mb-0">
            @for (err of validationErrors; track err.field) {
              <li>{{ err.message }}</li>
            }
          </ul>
        </div>
      }

      <!-- Form using JSON Form Component -->
      <div class="step-form">
        <app-json-form
          [fields]="fields"
          [model]="model"
          (modelChange)="onModelChange($event)"
          (fieldChange)="onFieldChange($event)">
        </app-json-form>

        <!-- Form Actions -->
        <div class="form-actions mt-4">
          <button
            type="button"
            class="btn btn-outline-secondary"
            (click)="cancel()"
          >
            <i class="bi bi-x-circle"></i> Cancel
          </button>

          @if (stepDefinition.stepConfig?.canSendBack) {
            <button
              type="button"
              class="btn btn-outline-warning"
              (click)="goBack()"
            >
              <i class="bi bi-arrow-left"></i> Send Back
            </button>
          }

          <button
            type="button"
            class="btn btn-outline-primary"
            (click)="validateForm()"
            [disabled]="validating"
          >
            @if (validating) {
              <span class="spinner-border spinner-border-sm me-2"></span>
            }
            <i class="bi bi-check-circle"></i> Validate
          </button>

          <button
            type="button"
            class="btn btn-primary"
            (click)="onSubmit()"
            [disabled]="!canSubmit"
            [title]="!canSubmit && stepDefinition?.stepConfig?.validation?.message ? stepDefinition.stepConfig.validation.message : ''"
          >
            @if (submitting) {
              <span class="spinner-border spinner-border-sm me-2"></span>
            }
            <i class="bi bi-arrow-right-circle"></i> Submit & Continue
          </button>
        </div>
        
        <!-- Validation hint -->
        @if (!canSubmit && stepDefinition?.stepConfig?.validation?.message) {
          <div class="alert alert-warning mt-3">
            <i class="bi bi-info-circle"></i> {{ stepDefinition.stepConfig.validation.message }}
          </div>
        }
      </div>

      <!-- Workflow Progress -->
      <div class="workflow-progress mt-5">
        <h5>Workflow History</h5>
        @if (instance.stepHistory && instance.stepHistory.length > 0) {
          <div class="timeline">
            @for (step of instance.stepHistory; track step.stepId) {
              <div class="timeline-item">
                <div class="timeline-marker"></div>
                <div class="timeline-content">
                  <h6>{{ step.stepId }}</h6>
                  <p class="text-muted mb-1">
                    Completed by {{ step.completedBy }} on {{ step.completedAt | date:'short' }}
                  </p>
                  @if (step.comments) {
                    <p class="mb-0"><em>{{ step.comments }}</em></p>
                  }
                </div>
              </div>
            }
          </div>
        } @else {
          <p class="text-muted">No history yet. This is the first step.</p>
        }
      </div>
    </div>
  }
</div>
