{
  "stepId": "saso_test_step3_products",
  "name": "Product Management",
  "actor": "customer",
  "description": "Add products with brand, sector, classification, measurements, and models",

  "schema": {
    "type": "object",
    "properties": {
      "existingProduct": {
        "type": "string",
        "title": "Select Existing Product"
      },
      "productTable": {
        "type": "array",
        "title": "Added Products",
        "items": {
          "type": "object",
          "properties": {
            "brandName": {
              "type": "string",
              "title": "Brand"
            },
            "sectorName": {
              "type": "string",
              "title": "Sector"
            },
            "classificationName": {
              "type": "string",
              "title": "Classification"
            },
            "modelName": {
              "type": "string",
              "title": "Model"
            },
            "modelNumber": {
              "type": "string",
              "title": "Model #"
            },
            "source": {
              "type": "string",
              "title": "Source"
            }
          },
          "required": ["brandName", "modelName"]
        }
      },
      "newProductBrandId": {
        "type": "string",
        "title": "Brand"
      },
      "newProductSectorId": {
        "type": "string",
        "title": "Sector"
      },
      "newProductClassificationId": {
        "type": "string",
        "title": "Classification"
      },
      "newProductModelName": {
        "type": "string",
        "title": "Model Name"
      },
      "newProductModelNumber": {
        "type": "string",
        "title": "Model Number"
      },
      "newProductBarcode": {
        "type": "string",
        "title": "Barcode"
      },
      "hasMeasurement": {
        "type": "boolean",
        "title": "Does this product have measurements?"
      },
      "measurementTable": {
        "type": "array",
        "title": "Product Measurements",
        "items": {
          "type": "object",
          "properties": {
            "name": {
              "type": "string",
              "title": "Measurement"
            },
            "value": {
              "type": "number",
              "title": "Value"
            },
            "unit": {
              "type": "string",
              "title": "Unit"
            }
          },
          "required": ["name", "value", "unit"]
        }
      }
    }
  },

  "uischema": {
    "type": "VerticalLayout",
    "elements": [
      {
        "type": "Control",
        "scope": "#/properties/existingProduct",
        "label": "Select Existing Product",
        "options": {
          "placeholder": "Choose a product to add..."
        }
      },
      {
        "type": "Control",
        "scope": "#/properties/productTable",
        "label": "Added Products",
        "options": {
          "detail": {
            "type": "HorizontalLayout",
            "elements": [
              { "type": "Control", "scope": "#/properties/brandName" },
              { "type": "Control", "scope": "#/properties/sectorName" },
              { "type": "Control", "scope": "#/properties/classificationName" },
              { "type": "Control", "scope": "#/properties/modelName" },
              { "type": "Control", "scope": "#/properties/modelNumber" },
              { "type": "Control", "scope": "#/properties/source" }
            ]
          }
        }
      },
      {
        "type": "Group",
        "label": "Add New Product",
        "elements": [
          {
            "type": "HorizontalLayout",
            "elements": [
              {
                "type": "Control",
                "scope": "#/properties/newProductBrandId",
                "options": { "placeholder": "Choose brand..." }
              },
              {
                "type": "Control",
                "scope": "#/properties/newProductSectorId",
                "options": { "placeholder": "Choose sector..." }
              },
              {
                "type": "Control",
                "scope": "#/properties/newProductClassificationId",
                "options": { "placeholder": "Choose classification..." }
              }
            ]
          },
          {
            "type": "HorizontalLayout",
            "elements": [
              {
                "type": "Control",
                "scope": "#/properties/newProductModelName",
                "options": { "placeholder": "Enter model name" }
              },
              {
                "type": "Control",
                "scope": "#/properties/newProductModelNumber",
                "options": { "placeholder": "Enter model number" }
              },
              {
                "type": "Control",
                "scope": "#/properties/newProductBarcode",
                "options": { "placeholder": "Enter barcode (optional)" }
              }
            ]
          }
        ]
      },
      {
        "type": "Control",
        "scope": "#/properties/hasMeasurement",
        "label": "Does this product have measurements?"
      },
      {
        "type": "Control",
        "scope": "#/properties/measurementTable",
        "label": "Product Measurements",
        "rule": {
          "effect": "SHOW",
          "condition": {
            "scope": "#/properties/hasMeasurement",
            "schema": { "const": true }
          }
        }
      }
    ]
  },

  "hooks": {
    "onInit": ["loadProducts", "loadSelectedBrands", "loadSectors", "loadClassifications"],
    "onChange": {
      "existingProduct": "onProductSelected"
    }
  },

  "stateMachine": {
    "initialStatus": "not_started",
    "allowedEvents": ["Enter", "Save", "Submit", "GoBack", "Complete"],
    "transitions": {
      "onEnter": { "from": "not_started", "to": "active" },
      "onSave": { "from": ["active", "in_progress"], "to": "in_progress" },
      "onSubmit": { "from": ["active", "in_progress"], "to": "completed" },
      "onGoBack": { "from": ["active", "in_progress"], "to": "active" },
      "onComplete": { "from": ["active", "in_progress"], "to": "completed", "workflowComplete": true }
    },
    "requiredForSubmit": ["productTable"],
    "canGoBack": true
  },

  "context": {
    "provides": ["productTable"],
    "requires": ["selectedTypeValue", "brandTable"],
    "filters": {
      "existingProduct": {
        "filterBy": "selectedTypeValue",
        "apiEndpoint": "/api/Products/by-type/{value}",
        "sourceField": "productType"
      }
    }
  },

  "stepConfig": {
    "canSendBack": true,
    "nextStep": "completed",
    "previousStep": "saso_test_step2_brands",
    "estimatedDurationHours": 48,
    "isLastStep": true,
    "validation": {
      "type": "productTable",
      "minRequired": 1,
      "message": "Please add at least one product before proceeding"
    }
  }
}
