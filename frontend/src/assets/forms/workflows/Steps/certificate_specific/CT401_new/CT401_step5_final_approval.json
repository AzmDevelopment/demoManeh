{
  "stepId": "CT401_step6_final_approval",
  "name": "Final Approval",
  "actor": "manager",
  "description": "Manager reviews inspector findings and makes final decision",
  
  "fields": [
    {
      "key": "inspectorFindings",
      "type": "textarea",
      "templateOptions": {
        "label": "Inspector Findings",
        "rows": 6,
        "disabled": true,
        "placeholder": "Summary from initial review..."
      },
      "expressionProperties": {
        "model.inspectorFindings": "formState.getInspectorFindings()"
      },
      "hooks": {
        "onInit": "loadInspectorFindings"
      }
    },
    {
      "key": "finalDecision",
      "type": "radio",
      "templateOptions": {
        "label": "Final Decision",
        "required": true,
        "options": [
          { "value": "approve", "label": "Approve Certificate" },
          { "value": "reject", "label": "Reject Application" }
        ]
      }
    },
    {
      "key": "approvalComments",
      "type": "textarea",
      "templateOptions": {
        "label": "Approval Comments",
        "rows": 5,
        "required": true
      }
    },
    {
      "key": "certificateValidity",
      "type": "input",
      "templateOptions": {
        "label": "Certificate Validity (Years)",
        "type": "number",
        "min": 1,
        "max": 5,
        "required": true
      },
      "hideExpression": "model.finalDecision !== 'approve'"
    },
    {
      "key": "managerSignature",
      "type": "file",
      "templateOptions": {
        "label": "Manager Digital Signature",
        "required": true,
        "accept": ".jpg,.png,.pdf"
      }
    },
    {
      "key": "approvalDate",
      "type": "date",
      "templateOptions": {
        "label": "Approval Date",
        "required": true,
        "disabled": true
      },
      "expressionProperties": {
        "model.approvalDate": "new Date().toISOString().split('T')[0]"
      }
    }
  ],
  
  "validationRules": [
    {
      "ruleId": "validateFinalDecision",
      "type": "required",
      "targetFields": ["finalDecision", "approvalComments"],
      "errorMessage": "Final decision and comments are required"
    },
    {
      "ruleId": "validateCertificateValidity",
      "type": "numericRange",
      "targetField": "certificateValidity",
      "condition": "finalDecision == 'approve'",
      "minValue": 1,
      "maxValue": 5,
      "errorMessage": "Certificate validity must be between 1-5 years"
    }
  ],
  
  "stepConfig": {
    "canSendBack": true,
    "sendBackTarget": "CT401_step2_initial_review",
    "canApprove": true,
    "canReject": true,
    "nextStep": "certificate_generation",
    "estimatedDurationHours": 24,
    "escalationAfterHours": 72,
    "requiredActor": "manager"
  },
  
  "permissions": {
    "manager": {
      "canEdit": ["finalDecision", "approvalComments", "certificateValidity"],
      "canView": ["inspectorFindings"],
      "canApprove": true,
      "canReject": true,
      "canSendBack": true
    },
    "director": {
      "canOverride": true,
      "canView": ["finalDecision", "approvalComments", "inspectorFindings"]
    }
  }
}
